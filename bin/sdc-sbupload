#!/bin/bash

if [[ $# != 1 || ! -f $1 ]]; then
    echo "Usage: $0 [ --proxy <protocol>://<proxyhost>:<proxyport> ] <filename>"
    exit 1
fi

OUTFILE=$1

PROXY=""

if [[ $OUTFILE == "--proxy" ]]; then
   PROXY="--proxy $2"
   OUTFILE=$3
fi

. /lib/sdc/config.sh
load_sdc_config
load_sdc_sysinfo

JOYENT_KEY=/smartdc/pubkey.key
ENCRYPTED_OUT=$(echo ${CONFIG_datacenter_company_name} | tr -cd [:alnum:] | tr [:upper:] [:lower:] ).${OUTFILE}.${SYSINFO_UUID}.`TZ=UTC date "+%Y%m%dT%H%M%SZ"`

function encrypt_bundle
{
    gpg --import $JOYENT_KEY
    gpg --encrypt --recipient 'support@joyent.com' --always-trust --armor --output $ENCRYPTED_OUT $OUTFILE
}

function upload_bundle
{
    curl ${PROXY} -k -T ${ENCRYPTED_OUT} -u ${CONFIG_sbapi_http_user}:${CONFIG_sbapi_http_pass} ${CONFIG_sbapi_url}

}

encrypt_bundle
upload_bundle

